---
title: "Correlaciones variables poblacionales y ambientales D. trunculus"
subtitle: "Datos Monitoreo poblacional FEMP_AND_04"
author: "Mardones, M; Delgado, M"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: EDA_donux.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
output: 
  html_document:
    fig-caption: yes
    keep_md: true
    toc: true
    toc_deep: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: cosmo
    fontsize: 0.9em
    linestretch: 1.7
    html-math-method: katex
    self-contained: true
    code-tools: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup1}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      dev = 'jpeg',
                      dpi = 300, 
                      fig.align='center')
#XQuartz is a mess, put this in your onload to default to cairo instead
options(bitmapType = "cairo") 
# (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggridges)
library(readxl)
library(here)
library(lubridate)
library(readr)
library(ggthemes)
library(hrbrthemes)
library(viridis)
library(kableExtra)
library(ggalt)
library(see)
library(egg)
library(ggpmisc)
```

# CORRELACIONES

Identificar correlaciones entre variables relativas a los indicadores. La idea seria identificar variables respuestas como rendimiento y D15 cofrontadas con la otra información ambiental que rescata el proyecto FEMP-04

## Data Clorofila 

Lee data 
```{r}
ChlData <- read_excel("~/IEO/FEMP_04/Ambientales_Data/Clorofila_data/Medidas Clorofila a_playa.xlsx", 
    sheet = "RESULTADOS_CLOROFILA", skip = 3) %>%
  mutate(Fecha = as.Date(as.numeric(Fecha), origin = "1899-12-30")) %>% 
  janitor::clean_names()

# Verificar
glimpse(ChlData)
```

## Manipular estructura de datos 


Defino y separo las fechas entre Año, Mes y Día

```{r}
ChlData$fecha <- ymd(ChlData$fecha)  # porque tus fechas son YYYY-MM-DD
ChlData2 <- ChlData %>%
  mutate(
    DIA = day(fecha),
    MES = month(fecha),
    ANO = year(fecha)
  )

```



Identifico outliers y aspectos de la captura
```{r warning=FALSE}
# A function for dotplots
multi_dotplot <- function(filename, Xvar, Yvar){
  filename %>%
    ggplot(aes(x = {{Xvar}})) +
    geom_point(aes(y = {{Yvar}})) +
    theme_classic() +
    coord_flip() +
    labs(x = "Order of Data")}
#Select continuous variables to plot
Chldata3 <- ChlData %>%
  mutate(order = seq(1:nrow(ChlData2)))
p1 <- multi_dotplot(Chldata3, order, intensidad)
p2 <- multi_dotplot(Chldata3, order, Chldata3$ug_l_sea_water)
#Plot as a grid
ggarrange(p1, p2, nrow = 1)
```

```{r}
# ver NA
colSums(is.na(ChlData2))
```




Primero el comportamiento. de la variabe y luego su tendencia por sitios y por tiempo.

```{r}
histo1 <- ggplot(ChlData2, aes(ug_l_sea_water))+
  geom_histogram(stat = "bin",
                 binwidth = 0.1,
                 fill="white",
                 color=1)+
  theme_few()+
  coord_flip()
histo1
```


Manipulo los datos y estimo una media y desviacion por variable

```{r}
meanchl <- ChlData2 %>% 
  group_by(ANO,
           MES,
           punto_muestreo) %>% 
  summarise(MEANCON = mean(ug_l_sea_water), na.rm = TRUE,
            VARCON = sd(ug_l_sea_water),
            INTENSIDAD= mean(intensidad))
```

```{r, fig.align="center", warning=FALSE}
meach <- ggplot(meanchl %>%
        mutate(MES = case_when(
           MES == 1 ~ "January",
           MES == 2 ~ "February",
           MES == 3 ~ "March",
           MES == 4 ~ "April",
           MES == 5 ~ "May",
           MES == 6 ~ "June",
           MES == 7 ~ "July",
           MES == 8 ~ "August",
           MES == 9 ~ "September",
           MES == 10 ~ "October",
           MES == 11 ~ "November",
           MES == 12 ~ "December")) %>% 
         mutate(MES = factor(MES, levels = c("January", 
                                              "February", 
                                              "March",
                                              "April",
                                              "May",
                                              "June",
                                              "July",
                                              "August",
                                              "September",
                                              "October",
                                              "November", 
                                              "December"))) %>%
          drop_na(), 
                aes(x = factor(MES), y = MEANCON)) +
  geom_rect(aes(xmin = 7, xmax = 5, ymin = -Inf, ymax = Inf),  # del 1 mayo al 30 junio
  fill = "grey", alpha = 0.01, inherit.aes = FALSE) +
  geom_boxplot(alpha = 0.7, outlier.color = "red") +
  theme_few() +
  facet_grid(. ~ ANO) +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5,
                                   size = 8),
        axis.text.y = element_text(size = 8),
        legend.position = "none") +
  ylab("Concentration (ug/ml)") +
  xlab("") +
  ggtitle("") +
  ylim(0, 5)

meach

```
agrupado por punto

```{r}
meanchl3 <- ChlData2 %>% 
  group_by(ANO,
           MES) %>% 
  summarise(MEANCON = mean(ug_l_sea_water), na.rm = TRUE,
            VARCON = sd(ug_l_sea_water),
            INTENSIDAD= mean(intensidad))
```

```{r, fig.align="center", warning=FALSE}
meach <- ggplot(meanchl3 %>%
        mutate(MES = case_when(
           MES == 1 ~ "January",
           MES == 2 ~ "February",
           MES == 3 ~ "March",
           MES == 4 ~ "April",
           MES == 5 ~ "May",
           MES == 6 ~ "June",
           MES == 7 ~ "July",
           MES == 8 ~ "August",
           MES == 9 ~ "September",
           MES == 10 ~ "October",
           MES == 11 ~ "November",
           MES == 12 ~ "December")) %>% 
         mutate(MES = factor(MES, levels = c("January", 
                                              "February", 
                                              "March",
                                              "April",
                                              "May",
                                              "June",
                                              "July",
                                              "August",
                                              "September",
                                              "October",
                                              "November", 
                                              "December"))) %>%
          drop_na(), 
       aes(x = MES, y = MEANCON)) +
  geom_rect(aes(xmin = 5 - 0.5, xmax = 6 + 0.5, ymin = -Inf, ymax = Inf),  # sombreado del 1 mayo al 30 junio
            fill = "grey", alpha = 0.1, inherit.aes = FALSE) +
  geom_point(alpha = 0.7, col = "black", fill="green", size=2, shape=21) +
  geom_smooth(aes(x = as.numeric(MES)), method = "loess", se = FALSE, color = "black") +
  scale_x_discrete(drop = FALSE) +   # mantiene todos los meses aunque no haya datos
  theme_few() +
  facet_grid(. ~ ANO) +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5,
                                   size = 8),
        axis.text.y = element_text(size = 8),
        legend.position = "none") +
  ylab("Concentration (ug/ml)") +
  xlab("") +
  ggtitle("") +
  ylim(0, 5)

meach



```

Relacion entre Concentracion e intensidad

```{r warning=FALSE}
rl1 <- ggplot(ChlData %>% 
                  drop_na(), 
               aes(`ug/l Extracto`, Intensidad))+
    geom_point(alpha=.7,
               col="red") +
    geom_smooth(method= "lm",
                col=1)+
    theme_few()+ 
   # scale_x_continuous(breaks = seq(from = 2018, to = 2023, by = 1))+
 
    ylab("Extracto (ug/ml)") +
    xlab("Intensidad") +
  stat_smooth(method = "lm", se = FALSE, color = "blue") +
  stat_regline_equation(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
    label.x = 3, label.y = 750,
    size=2
  )

rl1
```

## Guardo la data 

Data correspondiente al objeto `meanchl`

```{r eval=FALSE}
saveRDS(meanchl, "Cloro.RDS")
```

## Data multiparametrico.


para leer varios `.xls.` usar este ejemplo:

[Leer multiples Excel](https://stackoverflow.com/questions/32888757/how-can-i-read-multiple-excel-files-into-r)


```{r}
library(xlsx)
setwd("~/IEO/DATA/Ambientales_Data/MultiParámetro")
data.files = list.files(pattern = "*.xlsx")
data <- lapply(data.files, function(x) read.xlsx(x, sheetIndex = 1))

for (i in data.files) {
    data <- rbind(data, read.xlsx(i, sheetIndex = 1))
}
```


