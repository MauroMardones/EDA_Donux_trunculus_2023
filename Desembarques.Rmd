---
title: "Desembarques D. trunculus"
subtitle: "Datos Monitoreo poblacional FEMP_AND_04"
author: "Mardones, M; Delgado, M"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: EDA_donux.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
output: 
  html_document:
    fig-caption: yes
    keep_md: true
    toc: true
    toc_deep: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: cosmo
    fontsize: 0.9em
    linestretch: 1.7
    html-math-method: katex
    self-contained: true
    code-tools: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup1}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      dev = 'jpeg',
                      dpi = 300, 
                      fig.align='center')
#XQuartz is a mess, put this in your onload to default to cairo instead
options(bitmapType = "cairo") 
# (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggridges)
library(readxl)
library(here)
library(lubridate)
library(readr)
library(ggthemes)
library(hrbrthemes)
library(viridis)
library(kableExtra)
library(ggalt)
library(rnaturalearth)
library(sf)
library(psych)
library(ggpubr)
library(purrr)
```

# DESEMBARQUES OFICIALES

## Data Oficial
Leo los datos entregados por E. Marco. Actualizar pedida con Junta Andalucia.

```{r}
Landings <- read_excel("Data/Desembarques/Data_13_23_Landings.xlsx")
#View(Landings)
```

Identifico las columnas necesarias para el análisis, que en este caso, serían las columnas con dato crudo.

```{r}
# Fecha original en formato "año-mes-día"
fecha_original <- ymd(Landings$MESANYO)
# Separar en año, mes y día
ANO <- year(fecha_original)
MES <- month(fecha_original)
DIA <- day(fecha_original)
# uno la base
landings2 <-cbind(ANO,MES,DIA,Landings)
unique(landings2$ESTABLECIMIENTO)
```


Grafico general de los desembarques

```{r}
landings3 <- landings2 %>% 
  group_by(ANO, MES, ESTABLECIMIENTO) %>% 
  summarise(LANDINGS = sum(TOTAL_KILOS)/1000)
```

```{r}
hist(landings3$LANDINGS)
quantile(landings3$LANDINGS)
```
Hay valores cercanos a las 14 t. por registro. Identificar si esto tiene sentido. Preguntar a MD.

```{r}
plotlam <- ggplot(landings3,aes(ANO, LANDINGS))+
  geom_bar(stat = "identity")+
  facet_grid(MES~ESTABLECIMIENTO)+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90,
                                     hjust = 1,
                                     vjust= 0.5))
plotlam
```

Otra viz

```{r out.width='100%', message=FALSE}
landpop <- ggplot(landings3 %>% 
         group_by(ANO, ESTABLECIMIENTO) %>% 
         summarise(LANDINGS1 =sum(LANDINGS))) +
  geom_lollipop(aes(x=ANO, 
                  y=LANDINGS1,
                  colour=ESTABLECIMIENTO), 
              size=0.9)+
  scale_colour_viridis_d(option="H")+
  scale_x_continuous(breaks = seq(from = 2013, 
                                  to = 2024, 
                                  by = 1))+
  theme_few() +
  theme(
    legend.position = "none",
    panel.border = element_blank(),
    panel.spacing = unit(0.1, "lines"),
    strip.text.x = element_text(size = 6),
    axis.text.x = element_text(angle = 90,
                               size = 5,
                               hjust = 1,
                                     vjust= 0.5),
    axis.text.y = element_text(size = 5)) +
  xlab("") +
  ylab("Desembarque (t) por Establecimiento") +
  facet_wrap(.~ESTABLECIMIENTO, ncol=4)+
  ylim(0, 15)
landpop
```



```{r fig.width=10, fig.height=5}
orderland <-   ggplot(landings3 %>% 
         group_by(ANO, ESTABLECIMIENTO) %>% 
         summarise(LANDINGS1 =sum(LANDINGS)) %>% 
           arrange(LANDINGS1) %>% 
           mutate(ESTABLECIMIENTO=factor(ESTABLECIMIENTO,
                                         ESTABLECIMIENTO)), 
         aes(x=ESTABLECIMIENTO, 
             y=LANDINGS1) ) +
    geom_bar(stat="identity", fill="#69b3a2") +
    facet_wrap(.~ANO)+
    coord_flip() +
    theme_ipsum() +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.position="none",
      axis.text.y = element_text(size = 7)
    ) +
    xlab("") +
    ylab("Desembarque total aculumado por Establecimiento")
orderland
```

```{r}

table(landings2$MES, landings2$ANO)


kbl(table(landings2$MES, landings2$ANO), 
    longtable = T, 
    booktabs = T, 
    caption = "Registros de Desembarque por año y mes") %>% 
   kable_styling(latex_options = c("striped",  "hold_position"))
```
Ahora un resumido por año


```{r fig.width=10, fig.height=5}
totalanual<-   ggplot(landings3 %>% 
         group_by(ANO) %>% 
         summarise(LANDINGS1 =sum(LANDINGS)) %>% 
          mutate(ANO=factor(ANO,ANO)), 
         aes(x=ANO, 
             y=LANDINGS1) ) +
    geom_bar(stat="identity", fill="#69b3a2") +
  geom_smooth(method = "loess")+
    theme_ipsum() +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.position="none",
      axis.text.y = element_text(size = 10)
    ) +
    xlab("") +
    ylab("Desembarque (t) total aculumado por a traves de los años")+
  ylim(0,250)
totalanual
```

write `.csv`

```{r}
total <- landings3 %>% 
  group_by(ANO) %>%
  summarise(LANDINGS1 =sum(LANDINGS))
write_csv(total, "Landingscoquina.csv")
```


## Correccion 


sin embargo, acá es necesario identificar las lonjas que reciben coquina desde el Parque Doñana. De acuerdo a esto, MD indica lo sig:


| Lonja  | Observación | 
|:-------|:------|
| "AYAMONTE (Lonja)"     |  Podría recibir + procedente de Isla Canela |
|"CALETA DE VELEZ (Lonja)" | Mediterraneo Andaluz. NO creo |
|"ESTEPONA (Lonja)"       | Mediterraneo Andaluz. NO creo |
| "FUENGIROLA (Lonja)"      | Mediterraneo Andaluz. NO creo |
| "ISLA CRISTINA (Lonja)" |  Podría recibir + procedente de Isla Canela |
|"LA ATUNARA (Lonja)"    | Cerca de Algeciras, DUDAS |
| "MALAGA (Lonja)"        | Mediterraneo Andaluz. NO creo |
| "MARBELLA (Lonja)"     |  Mediterraneo Andaluz. NO creo |
| "BONANZA (Lonja)"       | Seguro que recibe  |
| "BONANZA (Lonja)"  | Podría recibir + procedente de Isla Canela |
| "ALGECIRAS (Lonja)"      |       DUDAS |

procedo ahora a generar un vector anual con los datos filtrados 

```{r}

landcorr <- landings3 %>% 
  filter(ESTABLECIMIENTO %in% c ("AYAMONTE (Lonja)",
                              "ISLA CRISTINA (Lonja)",
                              "LA ATUNARA (Lonja)" ,
                              "BONANZA (Lonja)",
                              "BONANZA (Lonja)",
                              "ALGECIRAS (Lonja)"))

```

saco el plot con los datos filtrados relativos solo al Parque Doñana



```{r fig.width=10, fig.height=5}
filtrapd<-   ggplot(landcorr %>% 
         group_by(ANO, ESTABLECIMIENTO) %>% 
         summarise(LANDINGS1 =sum(LANDINGS)) %>% 
           arrange(LANDINGS1) %>% 
           mutate(ESTABLECIMIENTO=factor(ESTABLECIMIENTO,
                                         ESTABLECIMIENTO)), 
         aes(x=ESTABLECIMIENTO, 
             y=LANDINGS1) ) +
    geom_bar(stat="identity", fill="#69b3a2") +
    facet_wrap(.~ANO)+
    coord_flip() +
    theme_ipsum() +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.position="none",
      axis.text.y = element_text(size = 7)
    ) +
    xlab("") +
    ylab("Desembarque total aculumado por Establecimiento")
filtrapd
```
 ahora resumido por año y comparo con el no filtrado
 
 
```{r fig.width=10, fig.height=5}
totalanualfil<-   ggplot(landcorr %>% 
         group_by(ANO) %>% 
         summarise(LANDINGS1 =sum(LANDINGS)) %>% 
          mutate(ANO=factor(ANO,ANO)), 
         aes(x=ANO, 
             y=LANDINGS1) ) +
    geom_bar(stat="identity", fill="#69b3a2") +
  geom_smooth(method = "loess")+
    theme_ipsum() +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.position="none",
      axis.text.y = element_text(size = 10)
    ) +
    xlab("") +
    ylab("Desembarque (t) filtrado aculumado por a traves de los años")+
  ylim(0,250)

```


```{r}
ggarrange(totalanual , totalanualfil,
          ncol = 1)
```



## Leer datos de Chirla y Coquina

```{r}
archivo <- "Data/Desembarques/DESEM_CHI_COQ_2000_2025.xlsx"
hojas <- paste0("RESULTADOS (HOJA ", 1:5, ")")
datos <- map_df(hojas, ~ read_excel(archivo, sheet = .x), .id = "origen")
```


```{r}
datosuratlantico <- datos %>%
  filter(region == "SURATLÁNTICA") 
```

```{r}
library(dplyr)
library(ggplot2)

# Filtramos solo Chirla y Coquina
datos_filtrados <- datosuratlantico %>%
  filter(nombreEspecie %in% c("CHIRLA", "COQUINA"))

# --- Gráfico por Mes (toneladas) ---
g_mes <- datos_filtrados %>%
  group_by(nombreEspecie, fechaVentaMes, zonaProduccion) %>%
  summarise(totalToneladas = sum(totalKilos, na.rm = TRUE) / 1000, .groups = "drop") %>%
  ggplot(aes(x = fechaVentaMes, y = totalToneladas, fill = zonaProduccion)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ nombreEspecie, scales = "free_y") +
  labs(title = "Desembarques mensuales de Chirla y Coquina",
       x = "Mes", y = "Total (toneladas)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# --- Gráfico por Año (toneladas) ---
g_anio <- datos_filtrados %>%
  group_by(nombreEspecie, fechaVentaAnio, zonaProduccion) %>%
  summarise(totalToneladas = sum(totalKilos, na.rm = TRUE) / 1000,
            .groups = "drop") %>%
  ggplot(aes(x = fechaVentaAnio, 
             y = totalToneladas, fill = zonaProduccion)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ nombreEspecie, scales = "free_y") +
  labs(title = "Desembarques anuales de Chirla y Coquina",
       x = "Año", y = "Total (toneladas)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Mostrar gráficos
print(g_mes)
print(g_anio)

```



# Breakpoints


The analysis of structural breakpoints is based on fitting a regression model in which the relationship between the response variable and its predictors may change at unknown points in time. In its simplest form, the model can be expressed as


$$ y_t = x_t^\top \beta + u_t, \quad t = 1, \dots, T $$
where (y_t) represents the dependent variable, in this case the total kilograms landed each year, (x_t) is the explanatory variable (the year), (\beta) is a vector of regression parameters, and (u_t) is the error term. The assumption of a constant parameter vector (\beta) throughout the entire series may not hold if there are structural changes in the fishery, for example due to management interventions, shifts in resource abundance, or environmental impacts. To account for this, the model allows for a structural break at an unknown year (m). In such a case the regression parameters are different before and after the breakpoint:

$$
y_t =
\begin{cases}
x_t^\top \beta_1 + u_t, & t = 1, \dots, m \
x_t^\top \beta_2 + u_t, & t = m+1, \dots, T
\end{cases}
$$

Thus, the series is divided into two regimes, each characterized by its own set of regression parameters (\beta_1) and (\beta_2). The breakpoint (m) is estimated by minimizing the sum of squared residuals (SSR) across the two regimes, that is,

$$
\hat{m} = \arg \min_m \Bigg[ \sum_{t=1}^m (y_t - x_t^\top \hat{\beta}*1(m))^2
+ \sum*{t=m+1}^T (y_t - x_t^\top \hat{\beta}_2(m))^2 \Bigg].
$$

This criterion ensures that the chosen breakpoint corresponds to the year where the total explanatory power of the segmented regression is maximized. In practice, the procedure can be extended to detect multiple breakpoints, partitioning the series into several distinct regimes with different statistical properties.

Applied to the case of clam fisheries in Spain, where the time series of official landings often exhibits abrupt shifts caused by regulatory closures, license reductions, or ecological changes in stock abundance, the breakpoint analysis provides a rigorous statistical tool to identify the exact years when structural changes in landings occurred. By doing so, the method transforms a noisy time series into interpretable periods that can be directly related to historical events in fishery management or ecosystem variability.

The breakpoint analysis was conducted using the R package **strucchange** [@zeileis2002], which implements methods for testing and dating structural changes in linear regression models. 


```{r}

# Filtrar solo las dos especies
df_species <- datosuratlantico %>%
  filter(nombreEspecie %in% c("COQUINA", "CHIRLA")) %>%
  mutate(
    fechaVenta = dmy(fechaVenta),
    Year = year(fechaVenta)
  ) %>%
  group_by(Year, nombreEspecie, provincia) %>%
  summarise(totalKilos = sum(totalKilos, na.rm = TRUE), .groups = "drop")


df_long <- df_species %>%
  arrange(provincia, nombreEspecie, Year)

df_long %>%
  group_by(provincia, nombreEspecie) %>%
  summarise(n_years = n(), .groups = "drop") %>%
  arrange(n_years)

```
```{r eval=FALSE}
# Filtrar especies de interés y agregar por año y provincia
df_long <- datosuratlantico %>%
  filter(nombreEspecie %in% c("COQUINA", "CHIRLA")) %>%
  mutate(fechaVenta = lubridate::dmy(fechaVenta),
         Year = lubridate::year(fechaVenta)) %>%
  group_by(nombreEspecie, Year) %>%
  summarise(totalKilos = sum(totalKilos, na.rm = TRUE), .groups = "drop") %>%
  arrange(nombreEspecie, Year)

library(dplyr)
library(strucchange)
library(purrr)

results <- df_long %>%
  group_by(nombreEspecie) %>%
  group_map(~{
    n <- nrow(.x)
    if(n > 3){
      bp <- breakpoints(totalKilos ~ Year, data = .x, h = 3)
      data.frame(
        Year = .x$Year[bp$breakpoints],
        nombreEspecie = .y$nombreEspecie
      )
    } else {
      NULL
    }
  }, .keep = TRUE) %>% 
  bind_rows()


# Graficar
ggplot(df_long, aes(x = Year, y = totalKilos)) +
  geom_col() +
  geom_vline(data = results, aes(xintercept = Year, 
                                 color = nombreEspecie),
              size = 1) +
  facet_grid(nombreEspecie ~ ., scales = "free_y") +
  theme_bw() +
  labs(y = "Total Kilos vendidos", x = "Año",
       title = "Breakpoints en ventas de Chirla y Coquina por provincia") +
  scale_color_manual(values = c("COQUINA" = "#E69F00",
                                "CHIRLA" = "#56B4E9"))

```


