---
title: "Desembarques D. trunculus"
subtitle: "Datos Monitoreo poblacional FEMP_AND_04"
author: "Mardones, M; Delgado, M"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: EDA_donux.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
output: 
  html_document:
    fig-caption: yes
    keep_md: true
    toc: true
    toc_deep: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: cosmo
    fontsize: 0.9em
    linestretch: 1.7
    html-math-method: katex
    self-contained: true
    code-tools: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup1}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      dev = 'jpeg',
                      dpi = 300, 
                      fig.align='center')
#XQuartz is a mess, put this in your onload to default to cairo instead
options(bitmapType = "cairo") 
# (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggridges)
library(readxl)
library(here)
library(lubridate)
library(readr)
library(ggthemes)
library(hrbrthemes)
library(viridis)
library(kableExtra)
library(ggalt)
library(rnaturalearth)
library(sf)
library(psych)
```

# DESEMBARQUES OFICIALES

Leo los datos entregados por E. Marco. Actualizar pedida con Junta Andalucia.

```{r}
Landings <- read_excel("Data/Desembarques/Data_13_23_Landings.xlsx")
#View(Landings)
```

Identifico las columnas necesarias para el analisis, que en este caso,
serían las columnas condato crudo.

```{r}
# Fecha original en formato "año-mes-día"
fecha_original <- ymd(Landings$MESANYO)
# Separar en año, mes y día
ANO <- year(fecha_original)
MES <- month(fecha_original)
DIA <- day(fecha_original)
# uno la base
landings2 <-cbind(ANO,MES,DIA,Landings)
unique(landings2$ESTABLECIMIENTO)
```


Grafico general de los desembarques

```{r}
landings3 <- landings2 %>% 
  group_by(ANO, MES, ESTABLECIMIENTO) %>% 
  summarise(LANDINGS = sum(TOTAL_KILOS)/1000)
```

```{r}
hist(landings3$LANDINGS)
quantile(landings3$LANDINGS)
```
Hay valores cercanos a las 14 t. Identificar si esto tiene sentido. Preguntar a MD.

```{r}
plotlam <- ggplot(landings3,aes(ANO, LANDINGS))+
  geom_bar(stat = "identity")+
  facet_grid(MES~ESTABLECIMIENTO)+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90,
                                     hjust = 1,
                                     vjust= 0.5))
plotlam
```

Otra viz

```{r out.width='100%', message=FALSE}
landpop <- ggplot(landings3 %>% 
         group_by(ANO, ESTABLECIMIENTO) %>% 
         summarise(LANDINGS1 =sum(LANDINGS))) +
  geom_lollipop(aes(x=ANO, 
                  y=LANDINGS1,
                  colour=ESTABLECIMIENTO), 
              size=0.9)+
  scale_colour_viridis_d(option="H")+
  scale_x_continuous(breaks = seq(from = 2013, 
                                  to = 2024, 
                                  by = 1))+
  theme_few() +
  theme(
    legend.position = "none",
    panel.border = element_blank(),
    panel.spacing = unit(0.1, "lines"),
    strip.text.x = element_text(size = 6),
    axis.text.x = element_text(angle = 90,
                               size = 5,
                               hjust = 1,
                                     vjust= 0.5),
    axis.text.y = element_text(size = 5)) +
  xlab("") +
  ylab("Desembarque (t) por Establecimiento") +
  facet_wrap(.~ESTABLECIMIENTO, ncol=4)+
  ylim(0, 15)
landpop
```



```{r fig.width=10, fig.height=5}
orderland <-   ggplot(landings3 %>% 
         group_by(ANO, ESTABLECIMIENTO) %>% 
         summarise(LANDINGS1 =sum(LANDINGS)) %>% 
           arrange(LANDINGS1) %>% 
           mutate(ESTABLECIMIENTO=factor(ESTABLECIMIENTO,
                                         ESTABLECIMIENTO)), 
         aes(x=ESTABLECIMIENTO, 
             y=LANDINGS1) ) +
    geom_bar(stat="identity", fill="#69b3a2") +
    facet_wrap(.~ANO)+
    coord_flip() +
    theme_ipsum() +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.position="none",
      axis.text.y = element_text(size = 7)
    ) +
    xlab("") +
    ylab("Desembarque total aculumado por Establecimiento")
orderland
```


```{r}

table(landings2$MES, landings2$ANO)


kbl(table(landings2$MES, landings2$ANO), 
    longtable = T, 
    booktabs = T, 
    caption = "Registros de Desembarque por año y mes") %>% 
   kable_styling(latex_options = c("striped",  "hold_position"))
```
Ahora un resumido por año


```{r fig.width=10, fig.height=5}
totalanual<-   ggplot(landings3 %>% 
         group_by(ANO) %>% 
         summarise(LANDINGS1 =sum(LANDINGS)) %>% 
          mutate(ANO=factor(ANO,ANO)), 
         aes(x=ANO, 
             y=LANDINGS1) ) +
    geom_bar(stat="identity", fill="#69b3a2") +
  geom_smooth(method = "loess")+
    theme_ipsum() +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.position="none",
      axis.text.y = element_text(size = 10)
    ) +
    xlab("") +
    ylab("Desembarque (t) total aculumado por a traves de los años")
totalanual
```

write `.csv`

```{r}
total <- landings3 %>% 
  group_by(ANO) %>%
  summarise(LANDINGS1 =sum(LANDINGS))
write_csv(total, "Landingscoquina.csv")
```

